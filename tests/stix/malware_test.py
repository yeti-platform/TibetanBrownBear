"""Tests for the Stix2 bindings."""

import pytest

from stix2 import Malware as StixMalware

from yeti.core.errors import ValidationError
# from yeti.core.entities.entity import Entity
from yeti.core.entities.malware import Malware
from yeti.core.entities.entity import Entity

@pytest.mark.usefixtures('clean_db')
def test_malware_creation():
    """Tests the creation of a single Malware object."""
    malware = Malware(name='asd', labels=['label1'])
    # pylint: disable=protected-access
    assert malware._stix_object is not None
    assert isinstance(malware._stix_object, StixMalware)

@pytest.mark.usefixtures('clean_db')
def test_malformed_malware():
    """Tests that a Malware object missing fields cannot be created."""
    with pytest.raises(ValidationError):
        Malware(name='asd')

@pytest.mark.usefixtures('clean_db')
def test_save_malware():
    """Tests that a Malware object missing fields cannot be created."""
    malware = Malware(name='asd', labels=['label1'])
    saved = malware.save()
    assert saved is not None

@pytest.mark.usefixtures('clean_db')
def test_update_malware():
    """Tests that a Malware object is succesfully updated."""
    kc_phases = [{'kill_chain_name': 'cyber', 'phase_name': 'cyber1'}]
    malware = Malware(
        name='asd', labels=['label1'], description='123',
        kill_chain_phases=kc_phases)
    malware.save()
    modified = malware.modified
    stix_id = malware.id
    updated = malware.update({'name': 'dsa'})
    assert updated.name == 'dsa'
    assert updated.description == '123'
    assert updated.kill_chain_phases == kc_phases
    assert malware.modified > modified
    assert updated.id == stix_id

@pytest.mark.usefixtures('clean_db')
def test_malware_versionning():
    """Tests that a getting a Malware object returns the most recent version."""
    malware = Malware(name='asd', labels=['label1'])
    malware.save()
    stix_id = malware.id
    malware.update({'name': 'dsa'})
    fetched = Malware.get(stix_id)
    assert fetched.id == stix_id
    assert fetched.created < fetched.modified

@pytest.mark.usefixtures('clean_db')
def test_all_versions():
    """Tests that a updating malware results in two versions."""
    malware = Malware(name='asd', labels=['label1']).save()
    malware.update({'name': 'dsa'})
    assert len(malware.all_versions()) == 2

@pytest.mark.usefixtures('clean_db')
def test_filter_latest_versions():
    """Tests that filtering only returns latest versions."""
    malware1 = Malware(name='malware1', labels=['label1']).save()
    Malware(name='malware2', labels=['label1']).save()
    mod_old = malware1.modified
    malware1.update({'name': 'malware11'})
    mod_new = Malware.filter({'name': 'malware1'})[0].modified
    assert str(mod_new) != str(mod_old)
    assert len(Malware.filter({'name': 'malware'})) == 2

@pytest.mark.userfixtures('populate_malware')
def test_malware_is_typed():
    """Tests that malware listed through Entities has correct type."""
    all_objects = Entity.list()
    for obj in all_objects:
        assert isinstance(obj, Malware)

@pytest.mark.usefixtures('clean_db')
def test_malware_delete():
    malware = Malware(name='asd', labels=['label1']).save()
    malware.update({'name': 'dsa'})
    assert len(Malware.list()) == 1
    malware.delete(all_versions=True)
    assert not Malware.list()
